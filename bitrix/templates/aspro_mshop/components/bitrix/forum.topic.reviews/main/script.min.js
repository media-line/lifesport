!function(a){a.FTRList=function(a){if(this.id="FTRList"+a.form.id,this.mess={},this.form=a.form,a.id)for(var b=0;b<a.id.length;b++)this.bind(a.id[b]);this.params={preorder:"Y"==a.preorder,pageNumber:a.pageNumber,pageCount:a.pageCount},BX.addCustomEvent(this.form,"onAdd",BX.delegate(this.add,this)),BX.addCustomEvent(this.form,"onRequest",BX.delegate(function(){if("undefined"!=typeof this.params.pageNumber){var a=BX.findChild(this.form,{attr:{name:"pageNumber"}});a||(a=BX.create("input",{props:{type:"hidden",name:"pageNumber"}}),this.form.appendChild(a)),a.value=this.params.pageNumber}if("undefined"!=typeof this.params.pageCount){var b=BX.findChild(this.form,{attr:{name:"pageCount"}});b||(b=BX.create("input",{props:{type:"hidden",name:"pageCount"}}),this.form.appendChild(b)),b.value=this.params.pageCount}},this)),BX.addCustomEvent(this.form,"onResponse",BX.delegate(function(){var a=BX.findChild(this.form,{attr:{name:"pageNumber"}},!0);a&&BX.remove(a)},this))},a.FTRList.prototype={add:function(b,c){var e,d=BX(this.form.id+"container"),f={className:/reviews-reply-form|reviews-collapse/},g=a.fTextToNode(c.message);if(d||(d=BX.create("div",{attrs:{id:this.form.id+"container"},props:{className:"reviews-block-container reviews-reviews-block-container"},children:[BX.create("div",{props:{className:"reviews-block-outer"},children:[BX.create("div",{props:{className:"reviews-block-inner"}})]})]}),a.fReplaceOrInsertNode(d,null,BX.findChild(document,f,!0).parentNode,f),d=BX(this.form.id+"container")),e=d?BX.findChild(d,{className:"reviews-block-inner"},!0):null,g&&e){if(c.allMessages){if(a.fReplaceOrInsertNode(g,e,BX.findChild(document,f,!0).parentNode,f),c.navigation&&c.pageNumber){var i,h=a.fTextToNode(c.navigation),j=h?BX.findChildren(d.parentNode,{className:"reviews-navigation-box"},!0):null;if(h){if(!j){d.parentNode.insertBefore(BX.create("div",{props:{className:"reviews-navigation-box reviews-navigation-top"}}),d);var k=d;do k=k.nextSibling;while(k&&1!=k.nodeType);var l=BX.create("div",{props:{className:"reviews-navigation-box reviews-navigation-bottom"}});k?d.parentNode.insertBefore(l,k):d.parentNode.appendChild(l),j=BX.findChildren(d.parentNode,{className:"reviews-navigation-box"},!0)}for(i=0;i<j.length;i++)j[i].innerHTML=h.innerHTML}this.params.pageNumber=c.pageNumber,this.params.pageCount=c.pageCount}if(c.messagesID&&"object"==typeof c.messagesID)for(var m=0;m<c.messagesID.length;m++)c.messagesID[m]!=b&&this.bind(c.messagesID[m])}else"undefined"!=typeof c.message&&(this.params.preorder?e.appendChild(g):e.insertBefore(g,e.firstChild));a.fRunScripts(c.message),this.bind(b)}},bind:function(a){var b=BX("message"+a);if(b){this.mess["m"+a]={node:b,author:{id:b.getAttribute("bx-author-id"),name:b.getAttribute("bx-author-name")}};var c=BX.findChildren(b,{tagName:"A",className:"reviews-button-small"},!0),d=BX.delegate(function(){var b=BX.proxy_context;this.act(b.getAttribute("bx-act"),a)},this),e=BX.delegate(function(){this.act("reply",a)},this),f=BX.delegate(function(){this.act("quote",a)},this);if(c&&c.length>0)for(var g=0;g<c.length;g++)"moderate"==c[g].getAttribute("bx-act")||"del"==c[g].getAttribute("bx-act")?BX.adjust(c[g],{events:{click:d},attrs:{"bx-href":c[g].getAttribute("href"),href:"javascript:void(0);"}}):this.form&&("reply"==c[g].getAttribute("bx-act")?BX.bind(c[g],"click",e):"quote"==c[g].getAttribute("bx-act")&&BX.bind(c[g],"mousedown",f))}},act:function(b,c){if(c&&this.mess["m"+c])if("quote"==b){var d=a.GetSelection();if(document.getSelection&&(d=d.replace(/\r\n\r\n/gi,"_newstringhere_").replace(/\r\n/gi," "),d=d.replace(/  /gi,"").replace(/_newstringhere_/gi,"\r\n\r\n")),""===d&&c>0&&BX("message_text_"+c,!0)){var e=BX("message_text_"+c,!0);"object"==typeof e&&e&&(d=e.innerHTML)}d=d.replace(/[\n|\r]*<br(\s)*(\/)*>/gi,"\n");var f=function(a,b){var c=" ",d=/showWMVPlayer.*?bx_wmv_player.*?file:[\s'"]*([^"']*).*?width:[\s'"]*([^"']*).*?height:[\s'"]*([^'"]*).*?/gi,e=d.exec(b);if(e&&(c="[VIDEO WIDTH="+e[2]+" HEIGHT="+e[3]+"]"+e[1]+"[/VIDEO]")," "==c){var f=/bxPlayerOnload[\s\S]*?[\s'"]*file[\s'"]*:[\s'"]*([^"']*)[\s\S]*?[\s'"]*height[\s'"]*:[\s'"]*([^"']*)[\s\S]*?[\s'"]*width[\s'"]*:[\s'"]*([^"']*)/gi;e=f.exec(b),e&&(c="[VIDEO WIDTH="+e[3]+" HEIGHT="+e[2]+"]"+e[1]+"[/VIDEO]")}return c};d=d.replace(/<script[^>]*>/gi,"").replace(/<\/script[^>]*>/gi,""),d=d.replace(/\001([^\002]*)\002/gi,f),d=d.replace(/<noscript[^>]*>/gi,"").replace(/<\/noscript[^>]*>/gi,""),d=d.replace(/\003([^\004]*)\004/gi," "),d=d.replace(/<table class\=[\"]*forum-quote[\"]*>[^<]*<thead>[^<]*<tr>[^<]*<th>([^<]+)<\/th><\/tr><\/thead>[^<]*<tbody>[^<]*<tr>[^<]*<td>/gi,""),d=d.replace(/<table class\=[\"]*forum-code[\"]*>[^<]*<thead>[^<]*<tr>[^<]*<th>([^<]+)<\/th><\/tr><\/thead>[^<]*<tbody>[^<]*<tr>[^<]*<td>/gi,""),d=d.replace(/<table class\=[\"]*data-table[\"]*>[^<]*<tbody>/gi,""),d=d.replace(/<\/td>[^<]*<\/tr>(<\/tbody>)*<\/table>/gi,""),d=d.replace(/[\r|\n]{2,}([\001|\002])/gi,"\n$1");for(var g=0;g++<50&&(d.search(/\002([^\002\003]*)\003/gi)>=0||d.search(/\001([^\001\003]*)\003/gi)>=0);)d=d.replace(/\002([^\002\003]*)\003/gi,"[CODE]$1[/CODE]").replace(/\001([^\001\003]*)\003/gi,"[QUOTE]$1[/QUOTE]");var h=function(a,b,c){for(var d=new RegExp("([^]*)("+b+")([^]*)","i"),e=new RegExp("((?:)(?:[^]*))("+b+")((?:[^]*)(?:))","i"),f=0;f++<300&&a.search(d)>=0;)a=a.replace(e,"$1"+c+"$3");return a};for(g=0;g++<10&&d.search(/\004([^\004\003]*)\003/gi)>=0;)d=h(d,"<tr>","[TR]"),d=h(d,"</tr>","[/TR]"),d=h(d,"<td>","[TD]"),d=h(d,"</td>","[/TD]"),d=d.replace(/\004([^\004\003]*)\003/gi,"[TABLE]$1[/TD][/TR][/TABLE]");d=BX.browser.IsIE()?d.replace(/<img(?:(?:\s+alt\s*=\s*\"?smile([^\"\s]+)\"?)|(?:\s+\w+\s*=\s*[^\s>]*))*>/gi,"$1"):d.replace(/<img.*?alt=[\"]*smile([^\"\s]+)[\"]*[^>]*>/gi,"$1"),d=d.replace(/<a[^>]+href=[\"]([^\"]+)\"[^>]+>([^<]+)<\/a>/gi,"[URL=$1]$2[/URL]"),d=d.replace(/<a[^>]+href=[\']([^\']+)\'[^>]+>([^<]+)<\/a>/gi,"[URL=$1]$2[/URL]"),d=d.replace(/<[^>]+>/gi," ").replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&quot;/gi,'"'),d=d.replace(/(smile(?=[:;8]))/g,""),d=d.replace(/\&shy;/gi,""),d=d.replace(/\&nbsp;/gi," "),BX.onCustomEvent(this.form,"onQuote",[{author:this.mess["m"+c].author,id:c,text:d}])}else if("reply"==b)BX.onCustomEvent(this.form,"onReply",[{author:this.mess["m"+c].author,id:c}]);else if("del"!=b||confirm(BX.message("f_cdm"))){if("moderate"==b||"del"==b){var i=BX.proxy_context,j=i.getAttribute("bx-href").replace(/.AJAX_CALL=Y/g,"").replace(/.sessid=[^&]*/g,""),k=BX.findParent(i,{tag:"table"}),l=BX.create("a",{attrs:{className:"reply-action-note"}}),m=function(){BX.remove(l),BX.show(i.parentNode)};BX.hide(i.parentNode),l.innerHTML=BX.message("f_wait"),i.parentNode.parentNode.appendChild(l),BX.ajax.loadJSON(j,{AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},BX.delegate(function(c){if(c.status&&k)if(BX.onCustomEvent(a,"onForumCommentAJAXAction",[b]),"del"==b){var d=a.curpage||top.window.location.href;BX.fx.hide(k,"scroll",{time:.15,callback_complete:BX.delegate(function(){BX.remove(k),m();var a=BX.findChild(BX(this.form.id+"container"),{class:"reviews-post-table"},!0,!0);(!a||a.length<1)&&this.params.pageNumber>1&&BX.reload(d)},this)})}else{var e=BX.hasClass(k,"reviews-post-hidden"),f=e?BX.message("f_hide"):BX.message("f_show"),g=BX.findChild(k,{className:"reviews-text"},!0);BX.fx.hide(g,"fade",{time:.1,callback_complete:function(){BX.toggleClass(k,"reviews-post-hidden"),i.innerHTML=f,j=j.replace(new RegExp("REVIEW_ACTION="+(e?"SHOW":"HIDE")),"REVIEW_ACTION="+(e?"HIDE":"SHOW")),i.setAttribute("bx-href",j),BX.fx.show(g,"fade",{time:.1}),m(),BX.style(g,"background-color",e?"#FFFFFF":"#E5F8E3")}})}else BX.addClass(l,"error"),l.innerHTML='<span class="errortext">'+c.message+"</span>"},this))}}else BX.DoNothing();else BX.DoNothing();return!1}},a.FTRForm=function(b){this.id="FTRForm"+b.form.id,this.form=b.form,this.editorName=b.editorName,this.editorId=b.editorId,this.editor=a[b.editorName],this.windowEvents={},this.editor?this.addParsers(this.editor):(this.windowEvents.LHE_OnInit=BX.delegate(function(a){a.id==this.editorId&&(this.addParsers(a),this.editor=a)},this),this.windowEvents.LHE_ConstructorInited=BX.delegate(function(a){a.id==this.editorId&&(this.editor||(this.addParsers(a),this.editor=a),this.editor.ucInited=!0)},this),BX.addCustomEvent(a,"LHE_OnInit",this.windowEvents.LHE_OnInit),BX.addCustomEvent(a,"LHE_ConstructorInited",this.windowEvents.LHE_ConstructorInited)),this.params={messageMax:64e3},BX.addCustomEvent(this.form,"onQuote",BX.delegate(function(a){this.show(),this.paste(a,"QUOTE")},this)),BX.addCustomEvent(this.form,"onReply",BX.delegate(function(a){this.show(),this.paste(a,"REPLY")},this))},a.FTRForm.prototype={addParsers:function(a){a.AddParser({name:"postuser",obj:{Parse:function(a,b,c){return b=b.replace(/\[USER\s*=\s*(\d+)\]((?:\s|\S)*?)\[\/USER\]/gi,function(a,b,d){return b=parseInt(b),d=BX.util.trim(d),'<span id="'+c.SetBxTag(!1,{tag:"postuser",params:{value:b}})+'" style="color: #2067B0; border-bottom: 1px dashed #2067B0;">'+d+"</span>"})},UnParse:function(a,b,c){if("postuser"==a.tag){for(var d="",e=0;e<b.arNodes.length;e++)d+=c._RecursiveGetHTML(b.arNodes[e]);return d=BX.util.trim(d),"[USER="+a.params.value+"]"+d+"[/USER]"}return""}}})},validate:function(b){var c=this.form,d="",e=c.REVIEW_TEXT.value.length;if(c.BXFormSubmit_save)return!0;if(c.TITLE&&c.TITLE.value.length<2&&(d+=BX.message("no_topic_name")),e<2?d+=BX.message("no_message"):0!==this.params.messageMax&&e>this.params.messageMax&&(d+=BX.message("max_len").replace(/\#MAX_LENGTH\#/gi,this.params.messageMax).replace(/\#LENGTH\#/gi,e)),""!==d)return alert(d),!1;var f=BX.findChild(c,{attribute:{name:"send_button"}},!0);f&&(f.disabled=!0);var g=BX.findChild(c,{attribute:{name:"view_button"}},!0);return g&&(g.disabled=!0),"Y"!=b||(BX.onCustomEvent(a,"onBeforeForumCommentAJAXPost",[c]),BX.onCustomEvent(this.form,"onRequest",[this,b]),setTimeout(BX.delegate(function(){BX.ajax.submit(c,BX.delegate(this.get,this))},this),50),!1)},get:function(){this.form.BXFormSubmit_save=null;var b=a.forumAjaxPostTmp;if(a.curpage=a.curpage||top.window.location.href,BX.onCustomEvent(a,"onForumCommentAJAXPost",[b,this.form]),"undefined"==typeof b||b.reload)return void BX.reload(a.curpage);if(b.status){if(b.allMessages||"undefined"!=typeof b.message)BX.onCustomEvent(this.form,"onAdd",[b.messageID,b]),this.clear();else if(b.previewMessage){var c=BX.findChild(document,{className:"reviews-preview"},!0),d=BX.findChild(document,{className:/reviews-reply-form|reviews-collapse/},!0).parentNode,e=a.fTextToNode(b.previewMessage);a.fReplaceOrInsertNode(e,c,d,{className:/reviews-reply-form|reviews-collapse/}),a.PostFormAjaxStatus(""),a.fRunScripts(b.previewMessage)}var f=b.messageID?BX("message"+b.messageID):null;f&&BX.scrollToNode(f)}for(var g=this.form.getElementsByTagName("input"),h=0;h<g.length;h++){var i=g[h];"submit"==i.getAttribute("type")&&(i.disabled=!1)}b.statusMessage&&a.PostFormAjaxStatus(b.statusMessage),BX.onCustomEvent(this.form,"onResponse",[b,this.form]),BX.onCustomEvent(a,"onAfterForumCommentAJAXPost",[b,this.form])},clear:function(){if(this.editor.ReInit(""),this.editor.fAutosave&&BX.bind(this.editor.pEditorDocument,"keydown",BX.proxy(this.editor.fAutosave.Init,this.editor.fAutosave)),BX.type.isDomNode(this.form)){var a=BX.findChild(document,{className:"reviews-preview"},!0);a&&BX.remove(a);for(var c,d,e,b=0;(c=BX("upload_files_"+b++ +"_"+this.form.index.value))&&c;)(d=BX.findChild(c,{tag:"input"}))&&e&&(e=BX.clone(d),e.value="",d.parentNode.insertBefore(e,d),d.parentNode.removeChild(d)),BX.hide(c);var f=BX.findChild(this.form,{className:"forum-upload-file-attach"},!0);f&&BX.show(f);var g=BX.findChild(this.form,{className:"reviews-upload-info"},!0);g&&BX.hide(g);var h=null,i=BX.findChild(this.form,{attr:{name:"captcha_code"}},!0),j=BX.findChild(this.form,{attr:{name:"captcha_word"}},!0),k=BX.findChild(this.form,{className:"reviews-reply-field-captcha-image"},!0);k&&(h=BX.findChild(k,{tag:"img"})),i&&j&&h&&(j.value="",BX.ajax.getCaptcha(function(a){i.value=a.captcha_sid,h.src="/bitrix/tools/captcha.php?captcha_code="+a.captcha_sid}))}},show:function(){return BX.onCustomEvent(this.form,"onBeforeShow",[this]),BX.show(this.form.parentNode),BX.scrollToNode(BX.findChild(this.form,{attribute:{name:"send_button"}},!0)),setTimeout(BX.delegate(function(){this.editor.SetFocus(),BX.defer(this.editor.SetFocus,this.editor)()},this),100),BX.onCustomEvent(this.form,"onAfterShow",[this]),!1},hide:function(){return BX.onCustomEvent(this.form,"onBeforeHide",[this]),BX.hide(this.form.parentNode),BX.onCustomEvent(this.form,"onAfterHide",[this]),!1},transverse:function(){return"none"==this.form.parentNode.style.display?this.show():this.hide(),!1},paste:function(a,b){BX.onCustomEvent(this.form,"onPaste",[a,b,this]);var c=a.author?a.author:"",d=a.text?a.text:"",e=a.id?a.id:"";c?"code"==this.editor.sEditorMode&&this.editor.bBBCode?c=c.id>0?"[USER="+c.id+"]"+c.name+"[/USER]":c.name:"html"==this.editor.sEditorMode&&(c.name=c.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;"),c=c.id>0?'<span id="'+this.editor.SetBxTag(!1,{tag:"postuser",params:{value:c.id}})+'" style="color: #2067B0; border-bottom: 1px dashed #2067B0;">'+c.name+"</span>":"<span>"+c.name+"</span>"):c="","QUOTE"==b?"code"==this.editor.sEditorMode&&this.editor.bBBCode?this.editor.WrapWith("[QUOTE"+(e>0?" ID="+e:"")+"]","[/QUOTE]",(""!==c?c+BX.message("f_author")+"\n":"")+d):"html"==this.editor.sEditorMode&&this.editor.InsertHTML('<blockquote class="bx-quote" id="mess'+e+'">'+(""!==c?c+BX.message("f_author")+"<br/>":"")+this.editor.ParseContent(d,!0)+"</blockquote><br/>"):(d=(c?c+", ":"")+this.editor.ParseContent(d,!0),"code"==this.editor.sEditorMode&&this.editor.bBBCode?this.editor.WrapWith("","",d):"html"==this.editor.sEditorMode&&this.editor.InsertHTML(d)),this.editor.SetFocus(),BX.defer(this.editor.SetFocus,this.editor)()}},BX.ready(function(){if(BX.browser.IsIE()){var b,c,d,a=BX.findChildren(document,{className:"reviews-post-table"},!0);if(!a)return;for(b=0;b<a.length;b++)for(c=a[b].getElementsByTagName("*"),d=c.length;d--;)c[d].scrollWidth>c[d].offsetWidth&&(c[d].style.paddingBottom="20px",c[d].style.overflowY="hidden")}}),a.fTextToNode=function(a){var b=BX.create("div");return b.innerHTML=a,b.childNodes.length>0?b:null},a.PostFormAjaxStatus=function(b){var d,c=BX.findChild(document,{className:"reviews-note-box"},!0,!0);if(c)for(d=0;d<=c.length;d++)BX.remove(c[d]);var e=BX.findChild(document,{className:"reviews-block-container"},!0);if(e&&!(b.length<1)){var f=a.fTextToNode(b);if(f)for(var g=["reviews-reply-form","reviews-collapse"],h=e;(h=h.nextSibling)&&h;)if(1==h.nodeType){var i=!1;for(d=0;d<g.length;d++)if(BX.hasClass(h,g[d])){i=!0;break}if(i){h.parentNode.insertBefore(f,h);break}}}},a.SetReviewsAjaxPostTmp=function(b){a.forumAjaxPostTmp=b},a.fReplaceOrInsertNode=function(b,c,d,e){var f=null;return!!BX.type.isDomNode(d)&&(!(!BX.type.isDomNode(b)&&!BX.type.isArray(b)&&b.length>0&&!(b=a.fTextToNode(b)))&&(BX.type.isDomNode(c)&&(d=c.parentNode,f=c.nextSibling,d.removeChild(c)),f||(f=BX.findChild(d,e,!0)),f?f.parentNode.insertBefore(b,f):d.appendChild(b),!0))},a.fRunScripts=function(a){var b=BX.processHTML(a,!0);BX.ajax.processScripts(b.SCRIPT,!0)},a.ShowLastEditReason=function(a,b){b&&(a?b.style.display="block":b.style.display="none")},a.AttachFile=function(a,b,c,d){var e=null,f=!1;a=parseInt(a),b=parseInt(b),document.getElementById("upload_files_info_"+c).style.display="block";for(var g=a;g<a+b&&(e=document.getElementById("upload_files_"+g+"_"+c),e&&null!==typeof e);g++)if("none"==e.style.display){f=!0,e.style.display="block";break}var h=!f||g>=a+b-1;h===!0&&(d.style.display="none")},a.GetSelection=function(){var b,c="";return a.getSelection?(b=a.getSelection(),c=b.toString()):document.selection&&(b=document.selection,c=b.createRange().text),c}}(window);